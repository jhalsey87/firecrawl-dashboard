<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firecrawl Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Reduce visual noise - clean color palette */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
        }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Reduce unnecessary borders and shadows */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        /* Strategic use of color - only where it matters */
        .status-active {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .status-completed {
            color: var(--text-secondary);
        }

        /* Simple, clean progress bar */
        .progress-container {
            background: #e5e7eb;
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--accent-blue);
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Clean table-like job list */
        .job-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .job-row:hover {
            background: var(--bg-secondary);
        }

        .job-row:last-child {
            border-bottom: none;
        }

        /* Reduce icon clutter */
        .action-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .action-link:hover {
            color: var(--accent-blue);
        }

        /* Clean metric display */
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Hide until loaded */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-6">
        <!-- Simple header - no gradients or excessive styling -->
        <div class="mb-8 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold mb-1" style="color: var(--text-primary)">Firecrawl Monitor</h1>
                <p class="text-sm" style="color: var(--text-secondary)">Real-time crawl job tracking</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleAutoRefresh()" id="refresh-toggle" class="px-3 py-1.5 text-sm border rounded-md" style="border-color: var(--border-color); color: var(--text-secondary)">
                    <span id="refresh-icon">⏸</span> <span id="refresh-text">Pause</span>
                </button>
                <select id="refresh-interval" onchange="updateRefreshInterval()" class="px-3 py-1.5 text-sm border rounded-md" style="border-color: var(--border-color); color: var(--text-secondary)">
                    <option value="3">3s</option>
                    <option value="5" selected>5s</option>
                    <option value="10">10s</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                </select>
            </div>
        </div>

        <!-- Key metrics - direct attention with size and placement -->
        <div class="grid grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="flex justify-between items-start mb-2">
                    <div class="metric-label">Health</div>
                    <button onclick="checkHealth()" class="text-xs px-2 py-0.5 border rounded" style="border-color: var(--border-color); color: var(--text-secondary)">
                        Test
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <div id="health-indicator" class="w-2 h-2 rounded-full" style="background: #d1d5db"></div>
                    <div class="font-semibold" id="health-status" style="color: var(--text-primary)">—</div>
                </div>
            </div>
            <div class="card">
                <div class="metric-value status-active" id="active-count">0</div>
                <div class="metric-label">Active Jobs</div>
            </div>
            <div class="card">
                <div class="metric-value" style="color: var(--text-primary)" id="completed-count">0</div>
                <div class="metric-label">Completed Today</div>
            </div>
            <div class="card">
                <div class="metric-value" style="color: var(--text-secondary)" id="success-rate">—</div>
                <div class="metric-label">Success Rate</div>
            </div>
        </div>

        <!-- Active Jobs Section -->
        <div class="card mb-6" id="active-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Active Jobs</h2>
                <button onclick="refreshJobs()" class="action-link">Refresh</button>
            </div>
            <div id="active-jobs">
                <div class="text-center py-8" style="color: var(--text-secondary)">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Recent Jobs Section -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Recent Jobs</h2>
            <div id="recent-jobs">
                <div class="text-center py-8" style="color: var(--text-secondary)">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Simple new job form -->
        <div class="card mt-6">
            <h2 class="text-lg font-semibold mb-4">Start New Crawl</h2>
            <form onsubmit="startJob(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-primary)">URL</label>
                    <input
                        type="text"
                        id="crawl-url"
                        placeholder="https://example.com"
                        class="w-full px-3 py-2 border rounded-md"
                        style="border-color: var(--border-color)"
                        required
                    >
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary)">Max Pages</label>
                        <input
                            type="number"
                            id="crawl-limit"
                            value="10"
                            min="1"
                            max="100"
                            class="w-full px-3 py-2 border rounded-md"
                            style="border-color: var(--border-color)"
                        >
                    </div>
                    <div class="flex items-end">
                        <button
                            type="submit"
                            class="px-6 py-2 rounded-md text-white font-medium"
                            style="background: var(--accent-blue)"
                        >
                            Start Crawl
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isRefreshEnabled = true;
        let currentRefreshSeconds = 5;

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                const indicator = document.getElementById('health-indicator');
                const status = document.getElementById('health-status');

                if (data.overall_status === 'healthy') {
                    indicator.style.background = 'var(--accent-success)';
                    status.textContent = 'Healthy';
                    status.style.color = 'var(--accent-success)';
                } else if (data.overall_status === 'error') {
                    indicator.style.background = 'var(--accent-error)';
                    status.textContent = 'Error';
                    status.style.color = 'var(--accent-error)';
                } else {
                    indicator.style.background = 'var(--accent-warning)';
                    status.textContent = 'Warning';
                    status.style.color = 'var(--accent-warning)';
                }
            } catch (error) {
                const indicator = document.getElementById('health-indicator');
                const status = document.getElementById('health-status');
                indicator.style.background = 'var(--accent-error)';
                status.textContent = 'Offline';
                status.style.color = 'var(--accent-error)';
            }
        }

        function toggleAutoRefresh() {
            isRefreshEnabled = !isRefreshEnabled;

            const icon = document.getElementById('refresh-icon');
            const text = document.getElementById('refresh-text');
            const button = document.getElementById('refresh-toggle');

            if (isRefreshEnabled) {
                icon.textContent = '⏸';
                text.textContent = 'Pause';
                button.style.color = 'var(--text-secondary)';
                startAutoRefresh();
            } else {
                icon.textContent = '▶';
                text.textContent = 'Resume';
                button.style.color = 'var(--accent-blue)';
                stopAutoRefresh();
            }
        }

        function updateRefreshInterval() {
            const select = document.getElementById('refresh-interval');
            currentRefreshSeconds = parseInt(select.value);

            if (isRefreshEnabled) {
                stopAutoRefresh();
                startAutoRefresh();
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(refreshJobs, currentRefreshSeconds * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function refreshJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();

                // Update metrics
                document.getElementById('active-count').textContent = data.active_jobs?.length || 0;
                document.getElementById('completed-count').textContent = data.recent_jobs?.length || 0;

                // Calculate success rate
                const recentJobs = data.recent_jobs || [];
                const successfulJobs = recentJobs.filter(j => j.status === 'completed').length;
                const rate = recentJobs.length > 0 ? Math.round((successfulJobs / recentJobs.length) * 100) : 0;
                document.getElementById('success-rate').textContent = recentJobs.length > 0 ? `${rate}%` : '—';

                // Render active jobs
                renderActiveJobs(data.active_jobs || []);

                // Render recent jobs
                renderRecentJobs(data.recent_jobs || []);

            } catch (error) {
                console.error('Failed to refresh jobs:', error);
            }
        }

        function renderActiveJobs(jobs) {
            const container = document.getElementById('active-jobs');

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center py-8" style="color: var(--text-secondary)">No active jobs</div>';
                return;
            }

            container.innerHTML = jobs.map(job => {
                const progress = job.total_urls > 0 ? Math.round((job.completed_urls / job.total_urls) * 100) : 0;
                const url = job.metadata?.origin_url || (job.urls && job.urls[0]) || 'N/A';

                return `
                    <div class="job-row fade-in">
                        <div>
                            <div class="font-medium mb-1">${truncateUrl(url)}</div>
                            <div class="text-sm" style="color: var(--text-secondary)">${job.job_id}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium">${job.completed_urls} / ${job.total_urls}</div>
                            <div class="progress-container mt-1">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${formatTime(job.created_at)}
                        </div>
                        <div class="text-sm status-active">
                            Running
                        </div>
                        <div>
                            <button onclick="cancelJob('${job.job_id}')" class="action-link" style="color: var(--accent-error)">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentJobs(jobs) {
            const container = document.getElementById('recent-jobs');

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center py-8" style="color: var(--text-secondary)">No recent jobs</div>';
                return;
            }

            container.innerHTML = jobs.slice(0, 20).map(job => {
                const url = job.metadata?.origin_url || (job.urls && job.urls[0]) || 'N/A';
                const isSuccess = job.status === 'completed';

                return `
                    <div class="job-row fade-in">
                        <div>
                            <div class="font-medium mb-1">${truncateUrl(url)}</div>
                            <div class="text-sm" style="color: var(--text-secondary)">${job.job_id}</div>
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${job.completed_urls} / ${job.total_urls} pages
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${formatTime(job.created_at)}
                        </div>
                        <div class="text-sm ${isSuccess ? 'status-completed' : ''}" style="color: ${isSuccess ? 'var(--accent-success)' : 'var(--accent-error)'}">
                            ${job.status}
                        </div>
                        <div>
                            ${job.source === 'firecrawl' || job.job_type === 'crawl' ?
                                `<a href="/jobs/${job.job_id}/data" class="action-link">View Data</a>` :
                                '<span style="color: var(--text-secondary)">—</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function truncateUrl(url, maxLength = 50) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;

            return date.toLocaleDateString();
        }

        async function startJob(event) {
            event.preventDefault();

            const url = document.getElementById('crawl-url').value;
            const limit = document.getElementById('crawl-limit').value;

            try {
                const formData = new FormData();
                formData.append('urls', url);
                formData.append('limit', limit);
                formData.append('job_type', 'crawl');

                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    document.getElementById('crawl-url').value = '';
                    setTimeout(() => refreshJobs(), 1000);
                }
            } catch (error) {
                console.error('Failed to start job:', error);
            }
        }

        async function cancelJob(jobId) {
            if (!confirm('Cancel this job?')) return;

            try {
                await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                setTimeout(() => refreshJobs(), 500);
            } catch (error) {
                console.error('Failed to cancel job:', error);
            }
        }

        // Initial load
        refreshJobs();
        checkHealth();

        // Start auto-refresh
        startAutoRefresh();
    </script>
</body>
</html>
