<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firecrawl Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Skip to main content link for keyboard users */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-blue);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Visible focus indicators for keyboard navigation */
        button:focus-visible,
        select:focus-visible,
        input:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }
        /* Reduce visual noise - clean color palette */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569; /* Darkened for better contrast (was #64748b) */
            --border-color: #e2e8f0;
            --accent-blue: #2563eb; /* Darkened for better contrast (was #3b82f6) */
            --accent-success: #059669; /* Darkened for better contrast (was #10b981) */
            --accent-warning: #d97706; /* Darkened for better contrast (was #f59e0b) */
            --accent-error: #dc2626; /* Darkened for better contrast (was #ef4444) */
        }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Reduce unnecessary borders and shadows */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        /* Strategic use of color - only where it matters */
        .status-active {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .status-completed {
            color: var(--text-secondary);
        }

        /* Simple, clean progress bar */
        .progress-container {
            background: #e5e7eb;
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--accent-blue);
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Clean table-like job list */
        .job-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .job-row:hover {
            background: var(--bg-secondary);
        }

        .job-row:last-child {
            border-bottom: none;
        }

        /* Reduce icon clutter */
        .action-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .action-link:hover {
            color: var(--accent-blue);
        }

        /* Clean metric display */
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Hide until loaded */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Live region for screen reader announcements -->
    <div aria-live="polite" aria-atomic="true" class="sr-only" id="status-announcements"></div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Simple header - no gradients or excessive styling -->
        <header class="mb-8 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold mb-1" style="color: var(--text-primary)">Firecrawl Monitor</h1>
                <p class="text-sm" style="color: var(--text-secondary)">Real-time crawl job tracking</p>
            </div>
            <div class="flex gap-3" role="group" aria-label="Dashboard controls">
                <button
                    onclick="toggleAutoRefresh()"
                    id="refresh-toggle"
                    class="px-3 py-1.5 text-sm border rounded-md"
                    style="border-color: var(--border-color); color: var(--text-secondary)"
                    aria-label="Toggle auto-refresh"
                    aria-pressed="true">
                    <span aria-hidden="true" id="refresh-icon">⏸</span> <span id="refresh-text">Pause</span>
                </button>
                <label for="refresh-interval" class="sr-only">Refresh interval</label>
                <select
                    id="refresh-interval"
                    onchange="updateRefreshInterval()"
                    class="px-3 py-1.5 text-sm border rounded-md"
                    style="border-color: var(--border-color); color: var(--text-secondary)"
                    aria-label="Select refresh interval">
                    <option value="3">3s</option>
                    <option value="5" selected>5s</option>
                    <option value="10">10s</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                </select>
            </div>
        </header>

        <!-- Key metrics - direct attention with size and placement -->
        <main id="main-content">
            <section class="grid grid-cols-4 gap-6 mb-8" role="region" aria-label="Key metrics">
                <div class="card">
                    <div class="flex justify-between items-start mb-2">
                        <div class="metric-label">Health</div>
                        <button
                            onclick="checkHealth()"
                            class="text-xs px-2 py-0.5 border rounded"
                            style="border-color: var(--border-color); color: var(--text-secondary)"
                            aria-label="Test health status">
                            Test
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div
                            id="health-indicator"
                            class="w-2 h-2 rounded-full"
                            style="background: #d1d5db"
                            role="status"
                            aria-label="Health status indicator"></div>
                        <div class="font-semibold" id="health-status" style="color: var(--text-primary)" aria-live="polite">—</div>
                    </div>
                </div>
            <div class="card">
                <div class="metric-value status-active" id="active-count" aria-label="Active jobs count" role="status">0</div>
                <div class="metric-label">Active Jobs</div>
            </div>
            <div class="card">
                <div class="metric-value" style="color: var(--text-primary)" id="completed-count" aria-label="Completed jobs today" role="status">0</div>
                <div class="metric-label">Completed Today</div>
            </div>
            <div class="card">
                <div class="metric-value" style="color: var(--text-secondary)" id="success-rate" aria-label="Success rate" role="status">—</div>
                <div class="metric-label">Success Rate</div>
            </div>
        </section>

        <!-- Active Jobs Section -->
        <section class="card mb-6" id="active-section" aria-labelledby="active-jobs-heading">
            <div class="flex justify-between items-center mb-4">
                <h2 id="active-jobs-heading" class="text-lg font-semibold">Active Jobs</h2>
                <button onclick="refreshJobs()" class="action-link" aria-label="Refresh job list">Refresh</button>
            </div>
            <div id="active-jobs" role="region" aria-live="polite" aria-label="Active jobs list">
                <div class="text-center py-8" style="color: var(--text-secondary)">
                    Loading...
                </div>
            </div>
            <!-- Active Jobs Pagination -->
            <div id="active-pagination" class="hidden flex justify-center items-center gap-2 mt-4 pt-4" style="border-top: 1px solid var(--border-color);">
                <button onclick="changeActivePage('prev')" id="active-prev" class="px-3 py-1 text-sm border rounded" style="border-color: var(--border-color); color: var(--text-secondary)" aria-label="Previous page of active jobs">
                    ← Previous
                </button>
                <span id="active-page-info" style="color: var(--text-secondary); font-size: 0.875rem;" aria-live="polite"></span>
                <button onclick="changeActivePage('next')" id="active-next" class="px-3 py-1 text-sm border rounded" style="border-color: var(--border-color); color: var(--text-secondary)" aria-label="Next page of active jobs">
                    Next →
                </button>
            </div>
        </section>

        <!-- Recent Jobs Section -->
        <section class="card" aria-labelledby="recent-jobs-heading">
            <h2 id="recent-jobs-heading" class="text-lg font-semibold mb-4">Recent Jobs</h2>
            <div id="recent-jobs" role="region" aria-live="polite" aria-label="Recent jobs list">
                <div class="text-center py-8" style="color: var(--text-secondary)">
                    Loading...
                </div>
            </div>
            <!-- Recent Jobs Pagination -->
            <div id="recent-pagination" class="hidden flex justify-center items-center gap-2 mt-4 pt-4" style="border-top: 1px solid var(--border-color);">
                <button onclick="changeRecentPage('prev')" id="recent-prev" class="px-3 py-1 text-sm border rounded" style="border-color: var(--border-color); color: var(--text-secondary)" aria-label="Previous page of recent jobs">
                    ← Previous
                </button>
                <span id="recent-page-info" style="color: var(--text-secondary); font-size: 0.875rem;" aria-live="polite"></span>
                <button onclick="changeRecentPage('next')" id="recent-next" class="px-3 py-1 text-sm border rounded" style="border-color: var(--border-color); color: var(--text-secondary)" aria-label="Next page of recent jobs">
                    Next →
                </button>
            </div>
        </section>

        <!-- Simple new job form -->
        <section class="card mt-6" aria-labelledby="start-crawl-heading">
            <h2 id="start-crawl-heading" class="text-lg font-semibold mb-4">Start New Crawl</h2>
            <form onsubmit="startJob(event)" class="space-y-4" aria-label="Start new crawl job">
                <div>
                    <label for="crawl-url" class="block text-sm font-medium mb-2" style="color: var(--text-primary)">URL</label>
                    <input
                        type="url"
                        id="crawl-url"
                        name="crawl-url"
                        placeholder="https://example.com"
                        class="w-full px-3 py-2 border rounded-md"
                        style="border-color: var(--border-color)"
                        aria-required="true"
                        required
                    >
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label for="crawl-limit" class="block text-sm font-medium mb-2" style="color: var(--text-primary)">Max Pages</label>
                        <input
                            type="number"
                            id="crawl-limit"
                            name="crawl-limit"
                            value="10"
                            min="1"
                            max="100"
                            class="w-full px-3 py-2 border rounded-md"
                            style="border-color: var(--border-color)"
                            aria-label="Maximum pages to crawl"
                        >
                    </div>
                    <div class="flex items-end">
                        <button
                            type="submit"
                            class="px-6 py-2 rounded-md text-white font-medium"
                            style="background: var(--accent-blue)"
                            aria-label="Start crawl job">
                            Start Crawl
                        </button>
                    </div>
                </div>
            </form>
        </section>
        </main>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isRefreshEnabled = true;
        let currentRefreshSeconds = 5;

        // Pagination variables
        const JOBS_PER_PAGE = 5;
        let allActiveJobs = [];
        let allRecentJobs = [];
        let activeCurrentPage = 1;
        let recentCurrentPage = 1;

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                const indicator = document.getElementById('health-indicator');
                const status = document.getElementById('health-status');

                if (data.overall_status === 'healthy') {
                    indicator.style.background = 'var(--accent-success)';
                    status.textContent = 'Healthy';
                    status.style.color = 'var(--accent-success)';
                    announce('Health check complete: System is healthy');
                } else if (data.overall_status === 'error') {
                    indicator.style.background = 'var(--accent-error)';
                    status.textContent = 'Error';
                    status.style.color = 'var(--accent-error)';
                    announce('Health check complete: System has errors');
                } else {
                    indicator.style.background = 'var(--accent-warning)';
                    status.textContent = 'Warning';
                    status.style.color = 'var(--accent-warning)';
                    announce('Health check complete: System has warnings');
                }
            } catch (error) {
                const indicator = document.getElementById('health-indicator');
                const status = document.getElementById('health-status');
                indicator.style.background = 'var(--accent-error)';
                status.textContent = 'Offline';
                status.style.color = 'var(--accent-error)';
                announce('Health check failed: System is offline');
            }
        }

        function announce(message) {
            const announcements = document.getElementById('status-announcements');
            announcements.textContent = message;
            setTimeout(() => { announcements.textContent = ''; }, 1000);
        }

        function toggleAutoRefresh() {
            isRefreshEnabled = !isRefreshEnabled;

            const icon = document.getElementById('refresh-icon');
            const text = document.getElementById('refresh-text');
            const button = document.getElementById('refresh-toggle');

            if (isRefreshEnabled) {
                icon.textContent = '⏸';
                text.textContent = 'Pause';
                button.style.color = 'var(--text-secondary)';
                button.setAttribute('aria-pressed', 'true');
                startAutoRefresh();
                announce('Auto-refresh enabled');
            } else {
                icon.textContent = '▶';
                text.textContent = 'Resume';
                button.style.color = 'var(--accent-blue)';
                button.setAttribute('aria-pressed', 'false');
                stopAutoRefresh();
                announce('Auto-refresh paused');
            }
        }

        function updateRefreshInterval() {
            const select = document.getElementById('refresh-interval');
            currentRefreshSeconds = parseInt(select.value);

            if (isRefreshEnabled) {
                stopAutoRefresh();
                startAutoRefresh();
            }
            announce(`Refresh interval set to ${currentRefreshSeconds} seconds`);
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(refreshJobs, currentRefreshSeconds * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function refreshJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();

                // Store all jobs for pagination
                allActiveJobs = data.active_jobs || [];
                allRecentJobs = data.recent_jobs || [];

                // Update metrics
                const activeCount = allActiveJobs.length;
                const completedCount = allRecentJobs.length;

                document.getElementById('active-count').textContent = activeCount;
                document.getElementById('completed-count').textContent = completedCount;

                // Calculate success rate
                const successfulJobs = allRecentJobs.filter(j => j.status === 'completed').length;
                const rate = allRecentJobs.length > 0 ? Math.round((successfulJobs / allRecentJobs.length) * 100) : 0;
                document.getElementById('success-rate').textContent = allRecentJobs.length > 0 ? `${rate}%` : '—';

                // Render paginated jobs
                updateActiveJobsPage();
                updateRecentJobsPage();

            } catch (error) {
                console.error('Failed to refresh jobs:', error);
                announce('Failed to refresh jobs');
            }
        }

        function updateActiveJobsPage() {
            const startIndex = (activeCurrentPage - 1) * JOBS_PER_PAGE;
            const endIndex = startIndex + JOBS_PER_PAGE;
            const pageJobs = allActiveJobs.slice(startIndex, endIndex);

            renderActiveJobs(pageJobs);
            updatePaginationControls('active', allActiveJobs.length, activeCurrentPage);
        }

        function updateRecentJobsPage() {
            const startIndex = (recentCurrentPage - 1) * JOBS_PER_PAGE;
            const endIndex = startIndex + JOBS_PER_PAGE;
            const pageJobs = allRecentJobs.slice(startIndex, endIndex);

            renderRecentJobs(pageJobs);
            updatePaginationControls('recent', allRecentJobs.length, recentCurrentPage);
        }

        function changeActivePage(direction) {
            const totalPages = Math.ceil(allActiveJobs.length / JOBS_PER_PAGE);

            if (direction === 'prev' && activeCurrentPage > 1) {
                activeCurrentPage--;
            } else if (direction === 'next' && activeCurrentPage < totalPages) {
                activeCurrentPage++;
            }

            updateActiveJobsPage();
            announce(`Active jobs page ${activeCurrentPage} of ${totalPages}`);
        }

        function changeRecentPage(direction) {
            const totalPages = Math.ceil(allRecentJobs.length / JOBS_PER_PAGE);

            if (direction === 'prev' && recentCurrentPage > 1) {
                recentCurrentPage--;
            } else if (direction === 'next' && recentCurrentPage < totalPages) {
                recentCurrentPage++;
            }

            updateRecentJobsPage();
            announce(`Recent jobs page ${recentCurrentPage} of ${totalPages}`);
        }

        function updatePaginationControls(type, totalJobs, currentPage) {
            const totalPages = Math.ceil(totalJobs / JOBS_PER_PAGE);
            const paginationDiv = document.getElementById(`${type}-pagination`);
            const prevBtn = document.getElementById(`${type}-prev`);
            const nextBtn = document.getElementById(`${type}-next`);
            const pageInfo = document.getElementById(`${type}-page-info`);

            // Show/hide pagination based on total jobs
            if (totalJobs > JOBS_PER_PAGE) {
                paginationDiv.classList.remove('hidden');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalJobs} total)`;

                // Enable/disable buttons
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;

                if (currentPage === 1) {
                    prevBtn.style.opacity = '0.5';
                    prevBtn.style.cursor = 'not-allowed';
                } else {
                    prevBtn.style.opacity = '1';
                    prevBtn.style.cursor = 'pointer';
                }

                if (currentPage === totalPages) {
                    nextBtn.style.opacity = '0.5';
                    nextBtn.style.cursor = 'not-allowed';
                } else {
                    nextBtn.style.opacity = '1';
                    nextBtn.style.cursor = 'pointer';
                }
            } else {
                paginationDiv.classList.add('hidden');
            }
        }

        function renderActiveJobs(jobs) {
            const container = document.getElementById('active-jobs');

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center py-8" style="color: var(--text-secondary)">No active jobs</div>';
                return;
            }

            container.innerHTML = jobs.map(job => {
                const progress = job.total_urls > 0 ? Math.round((job.completed_urls / job.total_urls) * 100) : 0;
                const url = job.metadata?.origin_url || (job.urls && job.urls[0]) || 'N/A';

                return `
                    <div class="job-row fade-in">
                        <div>
                            <div class="font-medium mb-1">${truncateUrl(url)}</div>
                            <div class="text-sm" style="color: var(--text-secondary)">${job.job_id}</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium">${job.completed_urls} / ${job.total_urls}</div>
                            <div class="progress-container mt-1">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${formatTime(job.created_at)}
                        </div>
                        <div class="text-sm status-active">
                            Running
                        </div>
                        <div>
                            <button onclick="cancelJob('${job.job_id}')" class="action-link" style="color: var(--accent-error)" aria-label="Cancel job ${job.job_id}">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentJobs(jobs) {
            const container = document.getElementById('recent-jobs');

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center py-8" style="color: var(--text-secondary)">No recent jobs</div>';
                return;
            }

            container.innerHTML = jobs.map(job => {
                const url = job.metadata?.origin_url || (job.urls && job.urls[0]) || 'N/A';
                const isSuccess = job.status === 'completed';

                return `
                    <div class="job-row fade-in">
                        <div>
                            <div class="font-medium mb-1">${truncateUrl(url)}</div>
                            <div class="text-sm" style="color: var(--text-secondary)">${job.job_id}</div>
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${job.completed_urls} / ${job.total_urls} pages
                        </div>
                        <div class="text-sm" style="color: var(--text-secondary)">
                            ${formatTime(job.created_at)}
                        </div>
                        <div class="text-sm ${isSuccess ? 'status-completed' : ''}" style="color: ${isSuccess ? 'var(--accent-success)' : 'var(--accent-error)'}">
                            ${job.status}
                        </div>
                        <div>
                            ${job.source === 'firecrawl' || job.job_type === 'crawl' ?
                                `<a href="/jobs/${job.job_id}/data" class="action-link" aria-label="View scraped data for job ${job.job_id}">View Data</a>` :
                                '<span style="color: var(--text-secondary)" aria-hidden="true">—</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function truncateUrl(url, maxLength = 50) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;

            return date.toLocaleDateString();
        }

        async function startJob(event) {
            event.preventDefault();

            const url = document.getElementById('crawl-url').value;
            const limit = document.getElementById('crawl-limit').value;

            try {
                const formData = new FormData();
                formData.append('urls', url);
                formData.append('limit', limit);
                formData.append('job_type', 'crawl');

                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('crawl-url').value = '';
                    announce(`Crawl job started for ${truncateUrl(url, 30)}`);
                    setTimeout(() => refreshJobs(), 1000);
                } else {
                    announce('Failed to start crawl job');
                }
            } catch (error) {
                console.error('Failed to start job:', error);
                announce('Failed to start crawl job');
            }
        }

        async function cancelJob(jobId) {
            if (!confirm('Cancel this job?')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                if (response.ok) {
                    announce('Job cancelled successfully');
                    setTimeout(() => refreshJobs(), 500);
                } else {
                    announce('Failed to cancel job');
                }
            } catch (error) {
                console.error('Failed to cancel job:', error);
                announce('Failed to cancel job');
            }
        }

        // Initial load
        refreshJobs();
        checkHealth();

        // Start auto-refresh
        startAutoRefresh();
    </script>
</body>
</html>
